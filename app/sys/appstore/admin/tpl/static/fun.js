if($('.app-local').length>0){let setUrl=function(url){parent.history.pushState(null,null,'?'+$.base64.encode(url.match(/\?(.*)/)[0]));parent.LBOX.attr('src',url)};$('.app-local .li>a').on('click',function(){setUrl($(this).attr('href'));return false});$('.app-repair').on('click',function(){var url=$(this).attr('data-url');layer.alert('我已做好数据备份，立即进行数据表修复。',{title:'提示'},function(index){layer.close(index);LJS._get(url,function(res){LJS._tips(res.msg,res.code)},'json')})});$('.app-uninstall').on('click',function(){var url=$(this).attr('data-url');layer.alert('卸载应用会删除应用文件和数据，请先做好备份！<br>卸载应用会删除应用文件和数据，请先做好备份！<br>卸载应用会删除应用文件和数据，请先做好备份！',{title:'提示'},function(index){layer.close(index);LJS._get(url,function(res){LJS._tips(res.msg,res.code);if(res.code==1){LJS._lazydo(function(){window.location.reload()})}},'json')})});if($('.app-update-btn').length>0){var applist=[],appli=$('.app-local .li');appli.each(function(index){applist[index]=$(this).data()});if(applist.length>0){LJS._post(LCMS.url.own_form+'check&c=store',{applist:JSON.stringify(applist)},function(res){if(res.code==1){appli.each(function(){var app=$(this).data();if(res.data[app.name]&&res.data[app.name].ver>app.ver){$(this).addClass('active').find('.layui-btn-disabled').removeClass('layui-btn-disabled').addClass('app-update').attr('data-ver',res.data[app.name].ver).attr('data-id',res.data[app.name].id)}})}},'json')};appli.on('click','.app-update',function(){var app=$(this).data();LJS._iframe(LCMS.url.own_form+'check&c=store&action=content&type=up&id='+app.id+'&appver='+app.ver,'立即更新')})};Sortable.create($('.app-local')[0],{handle:'.move',onEnd:function(){$('.submit').click()}});$('.app-local .move').length>0&&LJS._custommenu([{title:'设置默认应用',icon:'component',bgcolor:'#E6A23C',color:'',url:function(){LJS._iframe(LCMS.url.own_form+'setdefault','设置默认应用')}}])};if($('.install-progress').length>0){var api=LCMS['url']['own_form'],appinfo=$('.install-progress').data(),tips=$('.install-tips'),install=function(){tips.html('正在解压安装文件 请勿进行其它操作');LJS._post(api+'install',{action:'copy_files',appid:appinfo.id,appname:appinfo.name,appver:appinfo.ver},function(res){if(res.code=='1'){layui.element.progress('download','90%');tips.html('正在安装应用数据 请勿进行其它操作');LJS._post(api+'&n=backup&c=repair',{apptitle:'安装',appname:appinfo.name,},function(){layui.element.progress('download','95%');LJS._post(api+'install',{action:'get_oauth',appid:appinfo.id,appname:appinfo.name,appver:appinfo.ver,type:$('.install-progress').attr('data-type')},function(res){if(res.code==1){layui.element.progress('download','100%');tips.html('安装成功 页面即将刷新');LJS._lazydo(function(){parent.layer.closeAll();if("LBOX"==window.parent.frameElement.getAttribute("id")){parent.location.href="index.php?t=sys&n=appstore&c=local&a=&retime="+(new Date).getTime()}else{window.location.reload()}},2000)}else{tips.html('安装失败')}},'json')},'json')}else{tips.html('解压文件失败')}},'json')},download=function(){var timer;$.ajax({url:api+'install&action=down_file&appid='+appinfo.id+'&file='+appinfo.file,dataType:'json',cache:false,timeout:120000,success:function(res){install()},error:function(){tips.html('数据加载失败！');LJS._tips('数据加载失败！',0)},complete:function(){clearInterval(timer)}});timer=setInterval(()=>{LJS._get(api+'install&action=get_size&appid='+appinfo.id,function(res){if(res.code==1){layui.element.progress('download',Math.floor(res.data/appinfo.size*120)+'%')}},'json')},1000)};tips.html('正在获取需应用信息');LJS._post(api+'install',{action:'get_info',appid:appinfo.id,appver:appinfo.ver},function(res){if(res.code=='1'){appinfo=res.data;if(appinfo.file&&appinfo.size>'0.00'){tips.html('正在下载文件 请勿进行其它操作');download()}else{LJS._tips('安装失败',0)}}else{LJS._tips(res.msg,0)}},'json')};