if($('.app-repair').length>0){$('.app-repair').on('click',function(){var url=$(this).attr('data-url');layer.alert('我已做好数据备份，立即进行数据表修复。',{title:'提示'},function(index){layer.close(index);LJS._get(url,function(res){LJS._tips(res.msg,res.code)},'json')})})};if($('.app-uninstall').length>0){$('.app-uninstall').on('click',function(){var url=$(this).attr('data-url');layer.alert('卸载应用会删除应用文件和数据，请先做好备份！<br>卸载应用会删除应用文件和数据，请先做好备份！<br>卸载应用会删除应用文件和数据，请先做好备份！',{title:'提示'},function(index){layer.close(index);LJS._get(url,function(res){LJS._tips('卸载成功');LJS._lazydo(function(){window.location.reload()})},'json')})})};if($('.app-update-btn').length>0){var applist=[];$('tbody tr').each(function(index){applist[index]=$(this).data()});if(applist.length>0){$.ajax({url:LCMS.url.own_form+'check&c=store',data:{applist:applist},type:'POST',dataType:'json',cache:false,timeout:15000,success:function(res){if(res.code=='1'){$('tbody tr').each(function(index){var verbox=$(this).children('.newver');if(verbox.length>0){var app=$(this).data();if(res.data[app.name]&&res.data[app.name].ver>app.ver){verbox.html(''+'V'+res.data[app.name].ver);$(this).find('.layui-btn-disabled').removeClass('layui-btn-disabled').addClass('app-update').html('更新').attr('data-ver',res.data[app.name].ver).attr('data-id',res.data[app.name].id)}else{verbox.html('V'+app.ver)}}})}else{$('tbody tr').each(function(index){var verbox=$(this).children('.newver');if(verbox.length>0){verbox.html('V'+$(this).data().ver)}})}}})};$('table').on('click','.app-update',function(){var appinfo=$(this).data();LJS._iframe(LCMS.url.own_form+'check&c=store&action=content&type=up&appid='+appinfo.id+'&appver='+appinfo.ver,'立即更新')})};if($('.install-progress').length>0){var api=LCMS['url']['own_form'],appinfo=$('.install-progress').data(),tips=$('.install-tips');tips.html('正在获取需要下载的文件列表');var download=function(index){if(index<=appinfo.files){LJS._get(api+'install&action=get_files&appid='+appinfo.id+'&pack='+index+'&packs='+appinfo.files+'&appver='+appinfo.ver,function(res){if(res.code=='1'){var pre=Math.floor(index/appinfo.files*100);layui.element.progress('download',pre+'%');index++;download(index)}else{tips.html(res.msg);LJS._tips(res.msg,0)}},'json')}else{tips.html('正在解压安装文件 请勿进行其它操作');LJS._post(api+'install',{action:'copy_files',appid:appinfo.id,appname:appinfo.name,appver:appinfo.ver},function(res){if(res.code=='1'){tips.html('正在安装应用数据 请勿进行其它操作');LJS._post(api+'&n=backup&c=repair',{apptitle:'安装',appname:appinfo.name,},function(){LJS._post(api+'install',{action:'get_oauth',appid:appinfo.id,appname:appinfo.name,appver:appinfo.ver,type:$('.install-progress').attr('data-type')},function(res){if(res.code=='1'){tips.html('安装成功 页面即将刷新');LJS._lazydo(function(){parent.layer.closeAll();if("LBOX"==window.parent.frameElement.getAttribute("id")){parent.location.href="index.php?t=sys&n=appstore&c=local&a=&retime="+(new Date).getTime()}else{window.location.reload()}},2000)}else{tips.html('安装失败')}},'json')},'json')}else{tips.html('解压文件失败')}},'json')}};LJS._post(api+'install',{action:'get_info',appid:appinfo.id,appver:appinfo.ver},function(res){if(res.code=='1'){appinfo=res.data;if(appinfo.files>0){tips.html('正在下载文件 请勿进行其它操作');download(1)}else{LJS._tips('安装失败',0)}}else{LJS._tips(res.msg,0)}},'json')};