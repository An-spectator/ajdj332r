var Apost=function(url,data,callback){var loading=LJS._loadstart();if(data!=undefined){for(var key in data){url=url+'&'+key+'='+encodeURIComponent(data[key])}};$.ajax({url:url,type:'GET',dataType:'json',cache:false,timeout:0,success:function(res){(callback&&typeof(callback)==="function")&&callback(res)},error:function(){(callback&&typeof(callback)==="function")&&callback({code:0,msg:'数据加载失败！'})},complete:function(){LJS._loadend(loading)}})};if($('.backup').length>0){var backup=function(arr,index){if((arr.length-1)>=index){$('.backup-span').html('正在导出：'+arr[index]+' ['+(index+1)+'/'+arr.length+']');Apost(LCMS.url.own_form+'index&action=backup-table',{name:arr[index]},function(res){if(res.code=='1'){backup(arr,index+1)}})}else{Apost(LCMS.url.own_form+'index&action=backup-ok',{},function(res){if(res.code=='1'){LJS._tips(res.msg);LJS._lazydo(function(){window.location.reload()},2000)}else{LJS._tips(res.msg,0)}})}};$('.backup').on('click',function(){layer.alert("确认备份数据库？",{area:'120px'},function(){layer.closeAll();$('.backup').html('正在备份中 <i class="layui-icon layui-icon-refresh layui-anim layui-anim-rotate layui-anim-loop"></i>');$('.backup').addClass('layui-btn-disabled');Apost(LCMS.url.own_form+'index&action=backup',{},function(res){if(res.code=='1'){backup(res.data,0)}else{LJS._tips(res.msg,0)}})})});$('.backup-restore').on('click',function(){var info=JSON.parse($(this).attr('data-info'));layer.alert("确认恢复此数据？",{area:'120px'},function(){layer.closeAll();Apost(LCMS.url.own_form+'index&action=restore',info,function(res){if(res.code=='1'){LJS._tips(res.msg);LJS._lazydo(function(){window.location.reload()},2000)}else{LJS._tips(res.msg,0)}})})});$('.backup-del').on('click',function(){var info=JSON.parse($(this).attr('data-info'));layer.alert("确认删除此备份？",{area:'120px'},function(){layer.closeAll();Apost(LCMS.url.own_form+'index&action=del',info,function(res){if(res.code=='1'){LJS._tips(res.msg);LJS._lazydo(function(){window.location.reload()},2000)}else{LJS._tips(res.msg,0)}})})})};if($('.optimize').length>0){var tpl=$('.optimize-tpl').html();var tables=JSON.parse($('.optimize').attr('data-table'));var optimize=function(arr,index){if((arr.length-1)>=index){$('.optimize-span').html('数据表：'+arr[index].Name);Apost(LCMS.url.own_form+'index&action=check',{name:arr[index].Name,engine:arr[index].Engine},function(res){if(res.code=='1'){optimize(arr,index+1)}})}else{LJS._tips("优化完成");LJS._lazydo(function(){window.location.reload()},2000)}};for(let index=0;index<tables.length;index++){var table=tables[index];table.Rows=table.Rows?table.Rows:'0';table.Data_free=table.Data_free?table.Data_free:'0';if(table.Data_length>1048576){table.Data_length=(table.Data_length/1048576).toFixed(2)+'MB'}else{table.Data_length=(table.Data_length/1024).toFixed(2)+'KB'};if(table.Index_length>1048576){table.Index_length=(table.Index_length/1048576).toFixed(2)+'MB'}else{table.Index_length=(table.Index_length/1024).toFixed(2)+'KB'};$('tbody').append(LJS._tpl(tpl,table))};$('.optimize').on('click',function(){layer.alert("我已备份好数据，确认优化！",{area:'120px'},function(){layer.closeAll();$('.optimize').html('正在优化中 <i class="layui-icon layui-icon-refresh layui-anim layui-anim-rotate layui-anim-loop"></i>');$('.optimize').addClass('layui-btn-disabled');optimize(tables,0)})});$('tbody').on('click','.optimize-truncate',function(){var name=$(this).attr('data-name');layer.alert("确认清空 "+name+" 表数据（不可恢复）？",{area:'120px'},function(){layer.closeAll();Apost(LCMS.url.own_form+'index&action=truncate',{name:name},function(res){if(res.code=='1'){LJS._tips(res.msg);LJS._lazydo(function(){window.location.reload()},2000)}else{LJS._tips(res.msg,0)}})})})};if($('.repair').length>0){$('.repair').on('click',function(){var index=layer.alert("如果你手动更新框架，出现了数据库结构与最新版不匹配的情况，可使用此功能进行修复！<br/><span style='color:red'>请先做好数据库备份！！！</span>",{title:'修复框架数据库',area:'120px',btn:'我已备份，确认修复'},function(){LJS._post(LCMS.url.own_form+'&c=repair',{},function(res){if(res.code=='1'){LJS._tips(res.msg)}else{LJS._tips(res.msg,0)};layer.close(index)},'json',true)})})}