<?php
class CAPTCHA
{
    public $cfg = array();
    public function __construct($config)
    {
        $this->$cfg = $config;
    }
    /**
     * [get 获取html]
     * @return [type] [description]
     */
    public function get($callback = "")
    {
        $callback = $callback ? "{$callback}" : false;
        $css      = '<style type="text/css">.pansatech-captcha{position:relative;height:38px;font-size:14px;border-radius:2px;border:1px solid #d5d5d5;background:linear-gradient(to bottom,#fff 0,#f6f6f6 100%);cursor:pointer;zoom:1}.pansatech-captcha:hover{background:linear-gradient(to bottom,#f6f6f6 0,#fff 100%)}.pansatech-captcha-body{height:100%;line-height:38px;padding-left:40px;background-repeat:no-repeat;background-position:10px center}.pansatech-captcha-normal{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABcAAAAXCAYAAADgKtSgAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTM4IDc5LjE1OTgyNCwgMjAxNi8wOS8xNC0wMTowOTowMSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6Njk5MkQ2QzJCOTA2MTFFOUI3MjQ5MzQyMkM0NTIxQzgiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6Njk5MkQ2QzFCOTA2MTFFOUI3MjQ5MzQyMkM0NTIxQzgiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTcgKFdpbmRvd3MpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OUE4MURCMjFCMTA5MTFFOTk3NzVBMzRGMzExOEIyNDIiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OUE4MURCMjJCMTA5MTFFOTk3NzVBMzRGMzExOEIyNDIiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5SohliAAABw0lEQVR42qyVvy9DURTH2xvpQtqOoqRMrN3UqJMqUv4A7SBRIumCUVc/BhEi3fgDVER1woixiclUEgkxlYUYyvck35e83NyrL/pO8sl7fe+c732999zvDZbL5YAlFBgHsyAJBkEUNMEjuAUVcA1aNgFTZMA9WOc1D4ZAkNe89j5jEunSfofAHoiBVVAz1MiX18khSIMCmAIr4Nv05SJ8Br6YWAt4ixrzP1kfMonvgwdQDPwviqw/0MUnQZ9FuAR+DJQsA/Q6a6DIJudPD+mODcuX2p6LzpboOu32Ai7a/O0EuyXhYQ2eQUqxjyuWxKbrvq5d/4pTkBXxMXBjSDji3Drhnm/3syNDrWywpIjHwZMhYd5jl5jyGrLZlGtL+xnvIKIoHPVZPCIDKE5J3Gdx8Z+GcibfZ/FRcCfiJ2DOZ/GstKOiH8fobu449iik502AAXCpaPRrtE135Lgj25HT6gr0+ZZjXFXwCnY7nA6pfwPnuuUug+EOBpC6EbBk8nM5QWZAN0dOexRNM78HTLtPIv2YkxcL9OMd+nOF7Spb+gOE2cdJml4/16za7gwNuNZArDNFgUUKhjlAgwNugyvb6f8rwABnQ2mpMef0YQAAAABJRU5ErkJggg==);color:#525252}.pansatech-captcha-active{display:none;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABcAAAAXCAYAAADgKtSgAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTM4IDc5LjE1OTgyNCwgMjAxNi8wOS8xNC0wMTowOTowMSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NkVEM0JCRTRCOTA2MTFFOUE4QjRGQ0ZCNEVDRTlDREUiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NkVEM0JCRTNCOTA2MTFFOUE4QjRGQ0ZCNEVDRTlDREUiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTcgKFdpbmRvd3MpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OUE4MURCMjFCMTA5MTFFOTk3NzVBMzRGMzExOEIyNDIiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OUE4MURCMjJCMTA5MTFFOTk3NzVBMzRGMzExOEIyNDIiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5M+I8wAAAB0ElEQVR42qyVMUhCURSGr08J0ii3qCGVpMgKmgJr0yUqi4q31lJBtTXYFtKWg1NGgQ0NTWERRdRQaw2NUQRFugRtFUXwIOmcx3nge54H76o/fDzk3vvfy73H/7hid6qwkQLEgGkgCgQBP/ABFIAb4Ai4BkqcgcfGeBzYBCLMGG4wQCwBD8AacMadrlwNwA5wamPMKULzd2k9e3IcOAFGRHVaBDqASUCznnyrBmNDuD5rvZYxYEHUR/P0Zrq5Qo8npSa3T8y1q/qXURp9jXLrlTXOdKfEbJuqf5kNeoC4QnUsbdzZGNB/43emdZSbOoXmQ9Uao15+iyL/fs5Nj6J5gBsJe4OmO7UzXn1Kie+/H84i5KF/XIVxpislfG6vGPYPivXntNgIJ2WMUS0eygrTBvhQaGzc6UF/1rTKgTHqE6+lWFFHhW3dgJNDY9SrQulmEi5EA+sGEsaoWzTPcyPWDSSNUccuyHPc4J4Kny0/rGMsNwnjR6BPoaBP2s1Cw/23QxljQfleMoILgz5Xp+Dao3w3Re4KcFGj8SWwzHUijYI+V8OJJ4xGwbU5jXI9QY/i9PESlOOakwaNb4BpFC/r/iGgGfjCP0hZ97+y6/7/AgwAO5agCj6Rfv8AAAAASUVORK5CYII=);color:#4bc02c}.pansatech-captcha-dun{position:absolute;width:20px;top:0;right:10px;height:100%;line-height:38px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABcAAAAXCAYAAADgKtSgAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTM4IDc5LjE1OTgyNCwgMjAxNi8wOS8xNC0wMTowOTowMSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTcgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjIxMUJBOTk0QjEwOTExRTk4ODUxRTg0NDM5RTI3NkI1IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjIxMUJBOTk1QjEwOTExRTk4ODUxRTg0NDM5RTI3NkI1Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6MjExQkE5OTJCMTA5MTFFOTg4NTFFODQ0MzlFMjc2QjUiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MjExQkE5OTNCMTA5MTFFOTg4NTFFODQ0MzlFMjc2QjUiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz4r0qB5AAABvUlEQVR42uyVu0sDQRDGczFgY7TxUVpZWRkVSalBJAgiiqIpI0SwTH+FWMdSMH+BYBQRIj5AGxF8BFEI2KSxSJEYomITJJ7fyncwLFkvIOlc+LG7szPf3c3tzlqO4/ha1fy+FraWigfkZHB4XF9vBxNgHszQdgj2wDmoSed87sIsztYBpig4DTq19RXyDrJ80An48EpLGpRBBiyDILgESdBPkrQF6ZNhTFoXt+RuQVrU5AucgX1wAEpqrWvB/vF5291w3XvBLJgDk+pFkRbLS/wF9Lg2V1TYytpDXFu3Lq6npaKcXLsQXucXlDiWa37GVLxyXmTfJ2wqt7aY27T5NN+il/gT+5C2o+QxdrRdFtJijeI37MMir1WwKXzUuCpyHtZijeKn7BfVzxb2rGFs0VfGGsUf1UEDAyAi7J+GcYS+ecZ61paU+Hw3tzlwTHJMSUCkK9Wotuj7XHVt4BYM8dStGg7RNkiAezAK6s3UljqIgWsGK581iNZEMdsCcdaXGGOaLrlqW0XBK0UeOI9yHOdatNEW/O3N3XYFRsAO+yOxdgeWQOEvl4UKHmN6nkmCtoLXZWH936GN2rcAAwBFPoZ/t+kuNAAAAABJRU5ErkJggg==);background-repeat:no-repeat;background-position:right center}</style>';
        $html     = '<div class="pansatech-captcha" id="TencentCaptcha" data-appid="' . $this->$cfg['appid'] . '" data-cbfn="tencent_captcha_callback"><div class="pansatech-captcha-body pansatech-captcha-normal">腾讯防水墙人机验证系统</div><div class="pansatech-captcha-body pansatech-captcha-active">恭喜您！验证成功</div><div class="pansatech-captcha-dun"> </div></div>';
        $js       = "<script type=\"text/javascript\">var tencent_captcha_do='" . $callback . "';var tencent_captcha_callback=function(captcha_info){if(captcha_info.ret===0){document.getElementsByClassName('pansatech-captcha-dun')[0].innerHTML='<input type=\"hidden\" name=\"tencent_randstr\" value=\"'+captcha_info.randstr+'\"/><input type=\"hidden\" name=\"tencent_ticket\" value=\"'+captcha_info.ticket+'\"/>';document.getElementsByClassName('pansatech-captcha-normal')[0].style.display='none';document.getElementsByClassName('pansatech-captcha-active')[0].style.display='block';if(tencent_captcha_do!=='false'){eval(tencent_captcha_do+'()')}}};var TENCENTCAPTCHA={reset:function(){document.getElementsByClassName('pansatech-captcha-dun')[0].innerHTML='';document.getElementsByClassName('pansatech-captcha-normal')[0].style.display='block';document.getElementsByClassName('pansatech-captcha-active')[0].style.display='none'}};</script><script type=\"text/javascript\" src=\"https://ssl.captcha.qq.com/TCaptcha.js\" async defer></script>";
        return $css . $html . $js;
    }
    /**
     * [check 检查验证码]
     * @param  [type] $Ticket  [description]
     * @param  [type] $Randstr [description]
     * @return [type]          [description]
     */
    public function check($Ticket, $Randstr)
    {
        $url   = "https://ssl.captcha.qq.com/ticket/verify?";
        $query = http_build_query([
            "aid"          => $this->$cfg['appid'],
            "AppSecretKey" => $this->$cfg['appsecret'],
            "Ticket"       => $Ticket,
            "Randstr"      => $Randstr,
            "UserIP"       => CLIENT_IP,
        ]);
        $result = json_decode(http::get($url . $query), true);
        if ($result['response'] == "1") {
            return true;
        } else {
            return false;
        }
    }
}
