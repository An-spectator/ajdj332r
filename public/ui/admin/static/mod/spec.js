var tpl_spec='<div class="lcms-form-spec-li"><div class="lcms-form-spec-li-title"><input class="layui-input" type="text" name="[title]" value="[value]" placeholder="规格名称" lay-verify="required"/><div class="layui-btn-group"><a class="layui-btn layui-btn-sm layui-btn-normal lcms-form-spec-tag-add" data-index="[index]"><i class="layui-icon layui-icon-add-1"></i>添加规格</a><a class="layui-btn layui-btn-sm layui-btn-danger lcms-form-spec-li-del"><i class="layui-icon layui-icon-close"></i>删除</a></div></div><div class="layui-row lcms-form-spec-tags"></div></div>';var tpl_tag='<div class="layui-col-xs6 layui-col-sm4 layui-col-md3 layui-col-lg2 lcms-form-spec-tag"><input class="layui-input" type="text" name="[tag]" value="[value]" placeholder="规格内容" lay-verify="required"/><a class="layui-btn layui-btn-sm layui-btn-danger lcms-form-spec-tag-del"><i class="layui-icon layui-icon-close"></i></a><div class="clear"> </div></div>';var sort_tags=function(elm,id){Sortable.create(document.getElementById(id),{onUpdate:function(evt){var arr=get_table(elm);show_table(elm,arr)}})};var show_spec=function(elm,index,value,allindex){var tpl=tpl_spec;var name=elm.attr('data-name')+'[structure]';var tags_id='LCMSFORMSPECTAGS'+allindex+index;tpl=tpl.replace(/\[index\]/,index);tpl=tpl.replace(/\[value\]/,(value?value:''));tpl=tpl.replace(/\[title\]/,name+'['+index+'][title]');elm.find('.lcms-form-spec-box').append(tpl);elm.find('.lcms-form-spec-li:last .lcms-form-spec-tags').attr({'id':tags_id,'data-index':index});sort_tags(elm,tags_id);index++;elm.attr('data-index',index)};var show_tag=function(elm,box,index,value){var tpl=tpl_tag;var name=elm.attr('data-name')+'[structure]';tpl=tpl.replace(/\[value\]/,(value?value:''));tpl=tpl.replace(/\[tag\]/,name+'['+index+'][tags][]');box.append(tpl)};var spec_each=function(tags,arr,index){var cache=[];var index=0;for(var i=0;i<tags.length;i++){if(arr.length>0){for(var n=0;n<arr.length;n++){cache[index]=tags[i]+'$$'+arr[n];index++}}else{cache[index]=tags[i];index++}};return cache};var get_table=function(elm){var index=0;var rowspan=1;var list=elm.find('.lcms-form-spec-li-title input');var nlist=[];var arr={title:[],list:[]};for(var i=0;i<list.length;i++){var list2=$(list[i]).parent('.lcms-form-spec-li-title').next('.lcms-form-spec-tags').find('input');if(list2&&list2.length>0){nlist[index]=list[i];index++}};for(var i=nlist.length-1;i>=0;i--){var list2=$(nlist[i]).parent('.lcms-form-spec-li-title').next('.lcms-form-spec-tags').find('input');if(list2&&list2.length>0){arr['title'][i]={title:$(nlist[i]).val(),rowspan:rowspan};rowspan=list2.length*rowspan;var tags=[];list2.each(function(n){tags[n]=$(this).val()});arr['list']=spec_each(tags,arr['list'],i)}};return arr};var show_table=function(elm,arr,values){var name=elm.attr('data-name')+'[value]';var tpl_table='<table class="layui-table" lay-size="sm"><thead><tr></tr></thead><tbody></tbody></table>';var title=JSON.parse($.base64.decode(elm.attr('data-specs')));var table=elm.children('.layui-input-block').children('.lcms-form-spec-table');if(arr['title'].length>0){table.html(tpl_table);title=arr['title'].concat(title);for(var i=0;i<title.length;i++){var width=title[i].rowspan?' width="50px"':'';table.find('thead tr').append('<td align="center"'+width+'>'+title[i].title+'</td>')};for(var i=0;i<arr['list'].length;i++){var td='';var tt=arr['list'][i].split("$$");for(var n=0;n<title.length;n++){var rowspan=title[n].rowspan?' rowspan="'+title[n].rowspan+'"':'';if(rowspan){if(i%title[n].rowspan==0){td=td+'<td align="center"'+rowspan+'>'+tt[n]+'</td>'}else{td=td+''}}else{var base64=$.base64.encode(arr['list'][i]);if(values){var value=values[base64][title[n].value]?values[base64][title[n].value]:''}else{var value=''}td=td+'<td><input class="layui-input" name="'+name+'['+base64+']['+title[n].value+']" value="'+value+'"></td>'}};table.find('tbody').append('<tr>'+td+'</tr>')}}else{table.html('')}};$('.lcms-form-spec').each(function(allindex){top.LCMSUIINDEX++;var spec_elm=$(this);var spec_name=spec_elm.attr('data-name')+'[structure]';var spec_value=spec_elm.attr('data-value');spec_elm.attr('data-index',0);if(spec_value!=''){spec_value=JSON.parse($.base64.decode(spec_value));if(spec_value.value!=null){var index=spec_elm.attr('data-index');for(var i=0;i<spec_value.structure.length;i++){show_spec(spec_elm,index,spec_value.structure[i]['title'],top.LCMSUIINDEX);if(spec_value.structure[i]['tags']){for(var n=0;n<spec_value.structure[i]['tags'].length;n++){show_tag(spec_elm,spec_elm.children('.layui-input-block').children('.lcms-form-spec-box').children('.lcms-form-spec-li:eq('+i+')').children('.lcms-form-spec-tags'),index,spec_value.structure[i]['tags'][n])}};index++};if(spec_value.value){var arr=get_table(spec_elm);show_table(spec_elm,arr,spec_value.value)}}};spec_elm.on('click','.lcms-form-spec-btn',function(){show_spec(spec_elm,spec_elm.attr('data-index'),'标签名称',top.LCMSUIINDEX)});spec_elm.on('click','.lcms-form-spec-tag-add',function(){var box=$(this).parent('.layui-btn-group').parent('.lcms-form-spec-li-title').next('.lcms-form-spec-tags');show_tag(spec_elm,box,box.attr('data-index'),'')});spec_elm.on('click','.lcms-form-spec-li-del',function(){$(this).parent('.layui-btn-group').parent('.lcms-form-spec-li-title').parent('.lcms-form-spec-li').remove();var arr=get_table(spec_elm);show_table(spec_elm,arr)});spec_elm.on('click','.lcms-form-spec-tag-del',function(){$(this).parent('.lcms-form-spec-tag').remove();var arr=get_table(spec_elm);show_table(spec_elm,arr)});spec_elm.on('change','.lcms-form-spec-box',function(){var arr=get_table($(this));show_table(spec_elm,arr)})});