var newvalue=function(arr={}){var list=[];arr.each(function(){list.push($(this).attr('data-src'))});return list.join('|')};$('.lcms-form-upload-img-list').on('click','div._del',function(){var _li=$(this).parent('._icon').parent('._li');var box=_li.parent('.lcms-form-upload-img-list');_li.remove();box.parent('.layui-input-block').siblings('input').val(newvalue(box.find('img')))});$('.lcms-form-upload-img').each(function(index){var that=$(this);var list=that.children('input').val().split('|');var tpl='<div class="_li"><a href="{src}" target="_blank"><img class="layui-upload-img" src="{src}" data-src="{src}"/></a><div class="_icon"><div class="_del"><i class="layui-icon layui-icon-delete"></i></div></div></div>';for(var i=0;i<list.length;i++){if(list[i]){var box=that.children('.layui-input-block').children('.lcms-form-upload-img-list');box.append(LJS._tpl(tpl,{'src':list[i]}))}};var id='LCMSUPLOADSORTABLE-'+index;that.children('.layui-input-block').children('.lcms-form-upload-img-list').attr('id',id);that.children('.layui-input-block').children('.lcms-form-upload-btn').attr('data-id',id);Sortable.create(document.getElementById(id),{filter:'._del',onUpdate:function(evt){var id=evt.srcElement.id;$('#'+id).parent('.layui-input-block').siblings('input').val(newvalue($('#'+id).find('img')))}})});$('.lcms-form-upload-btn ._box').on('click',function(){var many=$(this).attr('data-many');var id=$(this).parent('.lcms-form-upload-btn').attr('data-id');if($(window).width()<540){var area=['100%','100%']}else{var area=['550px','550px']};layer.open({type:2,title:'本地图库',area:area,resize:false,scrollbar:false,content:'?n=upload&c=gallery&many='+many+'&id='+id})});var addimg=function(list){var many=$('.lcms-form-upload-gallery').attr('data-many');var id=$('.lcms-form-upload-gallery').attr('data-id');var that=$('#'+id)};$('.lcms-form-upload-btn ._up').on('click',function(){layer.close(layer.index)});$('.lcms-form-upload-btn ._up').each(function(index){var up=$(this),id='LCMSUPLOADBTN'+index,galleryid=$(this).parent('.lcms-form-upload-btn').attr('data-id'),many=$(this).attr('data-many'),that=$('#'+galleryid),tpl='<input type="file" accept="image/*" name="editorfile" style="position:absolute;left:0;top:0;width:44px;height:100%;opacity:0;">';up.attr('id',id);up.append(tpl);var do_upload=function(input,formData){$.ajax({url:LCMS['url']['admin']+'?n=upload&c=index&a=img',data:formData,processData:false,contentType:false,type:'POST',dataType:"json",success:function(res){if(res.code=="1"){var tpl='<div class="_li"><a href="{src}" target="_blank"><img class="layui-upload-img" src="{src}" data-src="{src}"/></a><div class="_icon"><div class="_del"><i class="layui-icon layui-icon-delete"></i></div></div></div>';if(many=='1'){that.append(LJS._tpl(tpl,{'src':res.data.dir+res.data.filename}))}else{that.html(LJS._tpl(tpl,{'src':res.data.dir+res.data.filename}))};that.parent('.layui-input-block').siblings('input').val(newvalue(that.find('img')));LJS._tips(res.msg)}else{LJS._tips(res.msg,0)}},error:function(){LJS._tips('请求接口出现异常',0)},complete:function(){input.remove();up.append(tpl)}})};up.on('click','input',function(){var input=$(this);input.change(function(){var mime=this.files[0].type;if(mime=='image/png'||mime=='image/gif'){var formData=new FormData();formData.append('file',this.files[0]);do_upload(input,formData)}else{lrz(this.files[0],{width:1980}).then(function(rst){do_upload(input,rst.formData)})}})})});